# Kafka Connect Iceberg Sink to MinIO AIStor
# This setup streams data from Kafka topics to Iceberg tables on MinIO
# Architecture: Source MinIO (4-node) -> Kafka -> Kafka Connect -> Destination MinIO (4-node)
#
# Configuration: Copy .env.sample to .env and configure your settings

services:
  # ============================================================================
  # Kafka Broker (KRaft mode - no Zookeeper required)
  # ============================================================================
  kafka:
    image: ${KAFKA_IMAGE:-confluentinc/cp-kafka:7.5.0}
    hostname: kafka
    container_name: kafka
    ports:
      - "${KAFKA_EXTERNAL_PORT:-9092}:9092"
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,EXTERNAL://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - kafka-iceberg

  # ============================================================================
  # Kafka Connect with Iceberg Sink Connector
  # ============================================================================
  kafka-connect:
    image: ${KAFKA_CONNECT_IMAGE:-confluentinc/cp-kafka-connect:7.5.0}
    hostname: kafka-connect
    container_name: kafka-connect
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "${KAFKA_CONNECT_PORT:-8083}:8083"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: kafka:29092
      CONNECT_REST_PORT: 8083
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_GROUP_ID: iceberg-connect-cluster

      # Storage topics
      CONNECT_CONFIG_STORAGE_TOPIC: connect-configs
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_TOPIC: connect-offsets
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_PARTITIONS: 5
      CONNECT_STATUS_STORAGE_TOPIC: connect-status
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_PARTITIONS: 3

      # Converters
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"

      # Plugin path
      CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components,/plugins

      # AWS credentials for SigV4 signing (used by Iceberg REST catalog)
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      AWS_REGION: us-east-1

      # Logging
      CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
      CONNECT_LOG4J_LOGGERS: org.apache.kafka.connect=INFO,org.apache.iceberg=INFO
    volumes:
      - ./plugins:/plugins:z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/connectors"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - kafka-iceberg

  # ============================================================================
  # Source MinIO Cluster (4 nodes) - with Kafka Log Targets
  # ============================================================================
  minio-source1:
    image: ${MINIO_SOURCE_IMAGE:-praveenminio/eos:log}
    hostname: minio-source1
    container_name: minio-source1
    command: server http://minio-source{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
      # API Logs -> apilogs topic
      MINIO_LOG_API_KAFKA_ENABLE: "on"
      MINIO_LOG_API_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_API_KAFKA_TOPIC: ${API_LOGS_TOPIC:-apilogs}
      # Error Logs -> errorlogs topic
      MINIO_LOG_ERROR_KAFKA_ENABLE: "on"
      MINIO_LOG_ERROR_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_ERROR_KAFKA_TOPIC: ${ERROR_LOGS_TOPIC:-errorlogs}
      # Audit Logs -> auditlogs topic
      MINIO_LOG_AUDIT_KAFKA_ENABLE: "on"
      MINIO_LOG_AUDIT_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_AUDIT_KAFKA_TOPIC: ${AUDIT_LOGS_TOPIC:-auditlogs}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-source1-data:/data
    networks:
      - kafka-iceberg

  minio-source2:
    image: ${MINIO_SOURCE_IMAGE:-praveenminio/eos:log}
    hostname: minio-source2
    container_name: minio-source2
    command: server http://minio-source{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
      # API Logs -> apilogs topic
      MINIO_LOG_API_KAFKA_ENABLE: "on"
      MINIO_LOG_API_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_API_KAFKA_TOPIC: ${API_LOGS_TOPIC:-apilogs}
      # Error Logs -> errorlogs topic
      MINIO_LOG_ERROR_KAFKA_ENABLE: "on"
      MINIO_LOG_ERROR_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_ERROR_KAFKA_TOPIC: ${ERROR_LOGS_TOPIC:-errorlogs}
      # Audit Logs -> auditlogs topic
      MINIO_LOG_AUDIT_KAFKA_ENABLE: "on"
      MINIO_LOG_AUDIT_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_AUDIT_KAFKA_TOPIC: ${AUDIT_LOGS_TOPIC:-auditlogs}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-source2-data:/data
    networks:
      - kafka-iceberg

  minio-source3:
    image: ${MINIO_SOURCE_IMAGE:-praveenminio/eos:log}
    hostname: minio-source3
    container_name: minio-source3
    command: server http://minio-source{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
      # API Logs -> apilogs topic
      MINIO_LOG_API_KAFKA_ENABLE: "on"
      MINIO_LOG_API_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_API_KAFKA_TOPIC: ${API_LOGS_TOPIC:-apilogs}
      # Error Logs -> errorlogs topic
      MINIO_LOG_ERROR_KAFKA_ENABLE: "on"
      MINIO_LOG_ERROR_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_ERROR_KAFKA_TOPIC: ${ERROR_LOGS_TOPIC:-errorlogs}
      # Audit Logs -> auditlogs topic
      MINIO_LOG_AUDIT_KAFKA_ENABLE: "on"
      MINIO_LOG_AUDIT_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_AUDIT_KAFKA_TOPIC: ${AUDIT_LOGS_TOPIC:-auditlogs}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-source3-data:/data
    networks:
      - kafka-iceberg

  minio-source4:
    image: ${MINIO_SOURCE_IMAGE:-praveenminio/eos:log}
    hostname: minio-source4
    container_name: minio-source4
    command: server http://minio-source{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
      # API Logs -> apilogs topic
      MINIO_LOG_API_KAFKA_ENABLE: "on"
      MINIO_LOG_API_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_API_KAFKA_TOPIC: ${API_LOGS_TOPIC:-apilogs}
      # Error Logs -> errorlogs topic
      MINIO_LOG_ERROR_KAFKA_ENABLE: "on"
      MINIO_LOG_ERROR_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_ERROR_KAFKA_TOPIC: ${ERROR_LOGS_TOPIC:-errorlogs}
      # Audit Logs -> auditlogs topic
      MINIO_LOG_AUDIT_KAFKA_ENABLE: "on"
      MINIO_LOG_AUDIT_KAFKA_BROKERS: kafka:29092
      MINIO_LOG_AUDIT_KAFKA_TOPIC: ${AUDIT_LOGS_TOPIC:-auditlogs}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-source4-data:/data
    networks:
      - kafka-iceberg

  # ============================================================================
  # Nginx Load Balancer for Source Cluster
  # ============================================================================
  nginx-source:
    image: nginx:alpine
    hostname: nginx-source
    container_name: nginx-source
    ports:
      - "${SOURCE_API_PORT:-9000}:9000"
      - "${SOURCE_CONSOLE_PORT:-9001}:9001"
    volumes:
      - ./nginx-source.conf:/etc/nginx/conf.d/default.conf:z,ro
    depends_on:
      minio-source1:
        condition: service_healthy
      minio-source2:
        condition: service_healthy
      minio-source3:
        condition: service_healthy
      minio-source4:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - kafka-iceberg

  # ============================================================================
  # Destination MinIO Cluster (4 nodes) - for Iceberg Tables
  # ============================================================================
  minio-dest1:
    image: ${MINIO_DEST_IMAGE:-quay.io/minio/aistor/minio:EDGE.2025-12-13T08-46-12Z}
    hostname: minio-dest1
    container_name: minio-dest1
    command: server http://minio-dest{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-dest1-data:/data
    networks:
      - kafka-iceberg

  minio-dest2:
    image: ${MINIO_DEST_IMAGE:-quay.io/minio/aistor/minio:EDGE.2025-12-13T08-46-12Z}
    hostname: minio-dest2
    container_name: minio-dest2
    command: server http://minio-dest{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-dest2-data:/data
    networks:
      - kafka-iceberg

  minio-dest3:
    image: ${MINIO_DEST_IMAGE:-quay.io/minio/aistor/minio:EDGE.2025-12-13T08-46-12Z}
    hostname: minio-dest3
    container_name: minio-dest3
    command: server http://minio-dest{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-dest3-data:/data
    networks:
      - kafka-iceberg

  minio-dest4:
    image: ${MINIO_DEST_IMAGE:-quay.io/minio/aistor/minio:EDGE.2025-12-13T08-46-12Z}
    hostname: minio-dest4
    container_name: minio-dest4
    command: server http://minio-dest{1...4}/data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_LICENSE: ${MINIO_LICENSE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - minio-dest4-data:/data
    networks:
      - kafka-iceberg

  # ============================================================================
  # Nginx Load Balancer for Destination Cluster
  # ============================================================================
  nginx-dest:
    image: nginx:alpine
    hostname: nginx-dest
    container_name: nginx-dest
    ports:
      - "${DEST_API_PORT:-9010}:9000"
      - "${DEST_CONSOLE_PORT:-9011}:9001"
    volumes:
      - ./nginx-dest.conf:/etc/nginx/conf.d/default.conf:z,ro
    depends_on:
      minio-dest1:
        condition: service_healthy
      minio-dest2:
        condition: service_healthy
      minio-dest3:
        condition: service_healthy
      minio-dest4:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - kafka-iceberg

  # ============================================================================
  # Init Container - Creates topics, warehouse, namespace, and deploys connector
  # ============================================================================
  init:
    image: python:3.11-slim
    container_name: kafka-iceberg-init
    depends_on:
      kafka:
        condition: service_healthy
      kafka-connect:
        condition: service_healthy
      nginx-source:
        condition: service_healthy
      nginx-dest:
        condition: service_healthy
      trino:
        condition: service_healthy
    volumes:
      - ./init-setup.py:/init-setup.py:ro,z
    environment:
      MINIO_SOURCE_ENDPOINT: http://nginx-source:9000
      MINIO_DEST_ENDPOINT: http://nginx-dest:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_CONNECT_URL: http://kafka-connect:8083
      WAREHOUSE_NAME: ${WAREHOUSE_NAME:-kafkawarehouse}
      NAMESPACE_NAME: ${NAMESPACE_NAME:-streaming}
      TRINO_HOST: trino
      TRINO_PORT: 8080
    entrypoint: >
      bash -c "
        pip install -q boto3 requests kafka-python trino &&
        python /init-setup.py
      "
    networks:
      - kafka-iceberg

  # ============================================================================
  # Trino Query Engine - For querying Iceberg tables
  # ============================================================================
  trino:
    image: ${TRINO_IMAGE:-trinodb/trino:477}
    hostname: trino
    container_name: trino
    depends_on:
      nginx-dest:
        condition: service_healthy
    environment:
      - CATALOG_MANAGEMENT=dynamic
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/status"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    ports:
      - "${TRINO_PORT:-9999}:8080"
    networks:
      - kafka-iceberg

networks:
  kafka-iceberg:
    driver: bridge

volumes:
  # Source cluster volumes
  minio-source1-data:
  minio-source2-data:
  minio-source3-data:
  minio-source4-data:
  # Destination cluster volumes
  minio-dest1-data:
  minio-dest2-data:
  minio-dest3-data:
  minio-dest4-data:
